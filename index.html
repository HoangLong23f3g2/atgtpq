<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMaster - Hệ Thống Huấn Luyện</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 0; 
            display: flex; /* Flex layout cho sidebar và content */
            min-height: 100vh;
        }
        *, ::before, ::after { box-sizing: border-box; }

        /* --- SIDEBAR STYLES (Style theo File C) --- */
        #sidebar {
            width: 280px;
            background-color: #2c3e50; /* Màu nền tối sang trọng */
            color: white;
            padding: 20px;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            overflow-y: auto;
            z-index: 50;
            transition: all 0.3s ease;
        }

        #sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            background-color: #34495e;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.2rem;
            border-bottom: 2px solid #1abc9c;
            cursor: pointer;
        }

        #sidebar ul {
            list-style-type: none;
            padding: 0;
        }

        #sidebar li {
            margin-bottom: 12px;
        }

        #sidebar li a {
            display: flex;
            align-items: center;
            padding: 15px;
            text-decoration: none;
            color: white;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 500;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }

        #sidebar li a:hover {
            transform: translateX(5px);
            box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
            filter: brightness(1.1);
        }

        #sidebar li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* --- MÀU SẮC MENU (Dịu mắt, không quá tương phản) --- */
        /* Tôi tạo một bảng màu dịu (muted/flat colors) */
        .bg-color-0 { background-color: #5D6D7E; } /* Xám xanh */
        .bg-color-1 { background-color: #cd6155; } /* Đỏ đất */
        .bg-color-2 { background-color: #af7ac5; } /* Tím nhạt */
        .bg-color-3 { background-color: #5499c7; } /* Xanh biển dịu */
        .bg-color-4 { background-color: #48c9b0; } /* Xanh ngọc */
        .bg-color-5 { background-color: #f39c12; } /* Cam đất */
        .bg-color-6 { background-color: #52be80; } /* Xanh lá dịu */
        
        .disabled-link {
            background-color: #95a5a6 !important;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- MAIN CONTENT STYLES --- */
        #main-content {
            margin-left: 280px; /* Chừa chỗ cho sidebar */
            padding: 30px;
            flex-grow: 1;
            width: calc(100% - 280px);
            transition: all 0.3s ease;
        }

        /* Responsive cho màn hình nhỏ */
        @media (max-width: 768px) {
            #sidebar {
                width: 0;
                padding: 0;
                overflow: hidden;
            }
            #main-content {
                margin-left: 0;
                width: 100%;
                padding: 15px;
            }
            /* Nút mở menu sẽ hiện ra (xử lý sau bằng JS nếu cần thiết, 
               nhưng ở đây tập trung vào PC/Tablet theo yêu cầu) */
        }

        /* --- UTILITIES TỪ FILE B (Giữ lại để đẹp) --- */
        .bg-white { background-color: #fff; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .text-indigo-600 { color: #4f46e5; }
        .text-gray-800 { color: #1f2937; }
        .text-green-600 { color: #16a34a; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .grid { display: grid; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .border { border: 1px solid #e5e7eb; }
        .transition { transition: all 0.2s; }
        .cursor-pointer { cursor: pointer; }
        
        /* Quiz Styles */
        .correct-answer { background-color: #d1fae5; border: 2px solid #34d399; }
        .wrong-answer { background-color: #fee2e2; border: 2px solid #f87171; }
        input[type="radio"] { transform: scale(1.2); margin-right: 10px; }
        
        /* Buttons */
        .btn-action {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .bg-indigo { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-green { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .bg-gray { background: #95a5a6; }

        /* Modal Styles */
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 2.5rem; border-radius: 1rem; width: 90%; max-width: 450px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideDown 0.4s ease-out;
            text-align: center;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }

        /* Header bar in main content */
        .top-bar {
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="modal-content">
            <div style="margin-bottom: 20px;">
                <i class="fas fa-user-graduate fa-3x text-indigo-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Đăng Nhập Hệ Thống</h2>
            <p class="text-gray-500 mb-6">Chọn tên của bạn để truy cập kho bài tập.</p>
            
            <select id="user-select" class="w-full p-3 border border-gray-300 rounded-lg mb-6 bg-gray-50 text-gray-800 text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="" disabled selected>-- Vui lòng chọn tên --</option>
                <option value="Nguyễn Văn An">Nguyễn Văn An</option>
                <option value="Trần Văn Bình">Trần Văn Bình</option>
                <option value="Huỳnh Văn Chương">Huỳnh Văn Chương</option>
            </select>
            
            <button onclick="handleLogin()" class="w-full btn-action bg-indigo text-lg">
                Xác nhận & Bắt đầu
            </button>
        </div>
    </div>

    <div id="sidebar">
        <h2 onclick="renderDashboard()">
            <i class="fas fa-shapes mr-2"></i> QuizMaster
        </h2>
        
        <ul id="sidebar-list">
            </ul>
        
        <div style="margin-top: auto; padding-top: 20px; text-align: center; font-size: 0.8rem; opacity: 0.6; border-top: 1px solid #ffffff33;">
            <p>Phiên bản Offline V3</p>
        </div>
    </div>

    <div id="main-content">
        <div class="top-bar">
            <div>
                <h1 class="text-xl font-bold text-gray-700" id="page-title">Trang Chủ</h1>
            </div>
            <div class="flex items-center">
                <div class="mr-3 text-right">
                    <p class="text-sm text-gray-500">Xin chào,</p>
                    <p class="font-bold text-indigo-600" id="user-display">Khách</p>
                </div>
                <div class="bg-indigo-100 p-2 rounded-full text-indigo-600">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>

        <div id="dynamic-area">
            </div>
    </div>

    <script>
        // --- DỮ LIỆU ---
        let currentUser = "";
        let currentContestId = null;
        let quizAnswers = {};

        const MOCK_CONTESTS = [
            { id: 27, name: "ATGT: Kỹ năng Đỗ xe (20 câu)", duration: 20, active: true },
            { id: 26, name: "ATGT: Kỹ thuật Lùi xe (18 câu)", duration: 60, active: false },
            { id: 800, name: "Tiếng Anh: Danh Từ Đếm Được", duration: 45, active: false },
            { id: 700, name: "Toán Học: Bài Toán Đố Thực Tế", duration: 20, active: false },
            { id: 600, name: "Toán Học: Phép Tính Cơ Bản", duration: 30, active: false },
            { id: 900, name: "Kiến thức Chung: Xã hội học", duration: 15, active: false }
        ];

        const MOCK_EXERCISES_ID27 = [
            { id: 341, question_text: "Hành động nào sau đây 'mời gọi' kẻ gian đập kính trộm đồ?", option_a: "Dán phim cách nhiệt.", option_b: "Để ví tiền, điện thoại, laptop hớ hênh trên ghế phụ.", option_c: "Lắp khóa vô lăng.", option_d: "Gập gương chiếu hậu.", correct_answer: "B", explanation: "Để đồ giá trị nơi dễ nhìn thấy kích thích lòng tham của kẻ gian." },
            { id: 340, question_text: "Để tránh rủi ro xe bị hư hại do môi trường, bạn nên TRÁNH đỗ xe ở đâu?", option_a: "Nơi có bóng mát nhân tạo.", option_b: "Dưới tán cây lớn (nguy cơ gãy cành) hoặc gần công trường.", option_c: "Trong hầm gửi xe.", option_d: "Nơi có camera an ninh.", correct_answer: "B", explanation: "" },
            { id: 326, question_text: "Hành vi đỗ xe ngược chiều lưu thông gây nguy hiểm như thế nào?", option_a: "Không nguy hiểm.", option_b: "Chỉ bị phạt nhẹ.", option_c: "Nguy hiểm khi ra lại làn do góc quan sát ngược.", option_d: "Mòn lốp.", correct_answer: "C", explanation: "" },
            { id: 329, question_text: "Khu vực nào sau đây tuyệt đối CẤM đỗ xe?", option_a: "Trước cổng nhà dân.", option_b: "Trên miệng cống thoát nước hoặc trạm xe buýt.", option_c: "Dưới bóng cây.", option_d: "Sát lề phải.", correct_answer: "B", explanation: "" },
            { id: 336, question_text: "Vật liệu nào dễ cháy nhất khi tiếp xúc ống xả nóng?", option_a: "Cát.", option_b: "Rơm rạ, lá cây khô.", option_c: "Nước.", option_d: "Bùn.", correct_answer: "B", explanation: "" },
            { id: 330, question_text: "Kỹ thuật 'Dutch Reach' ngăn ngừa tai nạn gì?", option_a: "Quên phanh tay.", option_b: "Mở cửa gây va chạm người đi sau.", option_c: "Điểm mù.", option_d: "Nhầm chân ga.", correct_answer: "B", explanation: "" },
            { id: 335, question_text: "Tại sao đỗ xe trên nắp cống có nguy cơ CHÁY NỔ?", option_a: "Nắp cống sắc.", option_b: "Khí metan tích tụ gặp nhiệt từ xe.", option_c: "Chuột cắn dây.", option_d: "Nắp yếu.", correct_answer: "B", explanation: "" },
            { id: 333, question_text: "Lợi ích của gập gương khi đỗ lề đường?", option_a: "Tránh va quẹt xe máy.", option_b: "Tránh bụi.", option_c: "Nghỉ hệ thống điện.", option_d: "Báo hiệu khóa.", correct_answer: "A", explanation: "" },
            { id: 332, question_text: "Tại sao phải kéo phanh tay dù đường bằng phẳng?", option_a: "Bảo vệ hộp số.", option_b: "Xe có thể trôi do độ dốc nhỏ khó thấy.", option_c: "Để đèn sáng.", option_d: "Khóa vô lăng.", correct_answer: "B", explanation: "" },
            { id: 325, question_text: "Bánh xe không được cách lề quá bao nhiêu?", option_a: "20cm.", option_b: "25cm.", option_c: "30cm.", option_d: "40cm.", correct_answer: "B", explanation: "" }
        ];

        // --- LOGIC HỆ THỐNG ---

        // 1. Khởi tạo Sidebar
        function initSidebar() {
            const list = document.getElementById('sidebar-list');
            let html = `<li><a href="#" onclick="renderDashboard()" class="bg-color-0"><i class="fas fa-home"></i> Trang Tổng Quan</a></li>`;
            
            // Các icon trang trí
            const icons = ["fa-car", "fa-truck", "fa-language", "fa-calculator", "fa-square-root-alt", "fa-globe"];

            MOCK_CONTESTS.forEach((contest, index) => {
                // Logic chọn màu xoay vòng (cycle through 1-6)
                const colorClass = `bg-color-${(index % 6) + 1}`;
                const iconClass = icons[index % icons.length];
                
                // Nếu active thì cho click, không thì disabled style
                if (contest.active) {
                    html += `
                        <li>
                            <a href="#" onclick="renderQuizPage(${contest.id})" class="${colorClass}">
                                <i class="fas ${iconClass}"></i>
                                ${contest.name}
                            </a>
                        </li>
                    `;
                } else {
                    html += `
                        <li>
                            <a href="#" onclick="alert('Dữ liệu bài này chưa được tải về bản Offline.')" class="${colorClass} disabled-link">
                                <i class="fas ${iconClass}"></i>
                                ${contest.name} (Khóa)
                            </a>
                        </li>
                    `;
                }
            });
            list.innerHTML = html;
        }

        // 2. Xử lý Login
        function handleLogin() {
            const select = document.getElementById('user-select');
            const val = select.value;
            if(!val) {
                alert("Vui lòng chọn tên để tiếp tục!");
                return;
            }
            currentUser = val;
            document.getElementById('user-display').innerText = currentUser;
            document.getElementById('login-modal').classList.add('hidden'); // Ẩn modal bằng CSS
            document.getElementById('login-modal').style.display = 'none'; // Đảm bảo ẩn hẳn
            renderDashboard();
        }

        // 3. Render Dashboard (Trang chủ)
        function renderDashboard() {
            document.getElementById('page-title').innerText = "Trang Tổng Quan";
            const area = document.getElementById('dynamic-area');
            
            area.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl animate-fade-in">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">
                        Chào mừng đến với hệ thống huấn luyện
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                            <h3 class="text-xl font-bold text-indigo-700 mb-2"><i class="fas fa-check-circle"></i> Trạng thái</h3>
                            <p class="text-gray-600">Bạn đang đăng nhập với tư cách: <strong>${currentUser}</strong></p>
                            <p class="text-gray-600 mt-2">Hãy chọn một bài tập từ <strong>Thanh bên trái</strong> để bắt đầu.</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-xl border border-green-100">
                            <h3 class="text-xl font-bold text-green-700 mb-2"><i class="fas fa-info-circle"></i> Thông tin phiên bản</h3>
                            <p class="text-gray-600">Phiên bản: <strong>V3 (Sidebar UI)</strong></p>
                            <p class="text-gray-600">Dữ liệu sẵn có: <strong>Bài thi ID 27</strong></p>
                        </div>
                    </div>
                    
                    <div class="mt-8 text-center">
                        <img src="https://img.freepik.com/free-vector/online-test-concept-illustration_114360-5474.jpg?w=900" 
                             alt="Illustration" style="max-height: 300px; max-width: 100%; border-radius: 12px;">
                    </div>
                </div>
            `;
        }

        // 4. Render Trang làm bài
        function renderQuizPage(contestId) {
            currentContestId = contestId;
            quizAnswers = {};
            const contest = MOCK_CONTESTS.find(c => c.id === contestId);
            // Ở bản demo này chỉ có data cho bài 27, nếu bài khác active mà chưa có data thì fallback
            const exercises = (contestId === 27) ? MOCK_EXERCISES_ID27 : [];

            if (exercises.length === 0) {
                alert("Dữ liệu câu hỏi đang cập nhật.");
                return;
            }

            document.getElementById('page-title').innerText = "Đang làm bài thi";

            const area = document.getElementById('dynamic-area');
            area.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h3 class="text-2xl font-bold text-indigo-600">${contest.name}</h3>
                        <span class="bg-yellow-100 text-yellow-800 py-1 px-3 rounded-full font-bold text-sm">
                            <i class="far fa-clock"></i> ${contest.duration} phút
                        </span>
                    </div>
                    
                    <form id="quiz-form">
                        <div class="space-y-6 mb-8">
                            ${exercises.map((ex, index) => renderQuestion(ex, index)).join('')}
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="button" onclick="renderDashboard()" class="btn-action bg-gray" style="flex:1">
                                <i class="fas fa-arrow-left"></i> Hủy bỏ
                            </button>
                            <button type="button" onclick="handleSubmitQuiz()" class="btn-action bg-green" style="flex:2">
                                <i class="fas fa-paper-plane"></i> NỘP BÀI
                            </button>
                        </div>
                    </form>
                </div>
            `;
            window.scrollTo(0, 0);
        }

        function renderQuestion(ex, index) {
            return `
                <div class="p-6 border border-gray-200 rounded-xl hover:bg-gray-50 transition" id="q-container-${ex.id}">
                    <p class="font-bold text-lg mb-4 text-gray-800">
                        <span class="text-indigo-500">Câu ${index + 1}:</span> ${ex.question_text}
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${['A', 'B', 'C', 'D'].map(opt => `
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer bg-white hover:border-indigo-400 transition">
                                <input type="radio" name="q-${ex.id}" value="${opt}" onclick="updateAnswer(${ex.id}, '${opt}')">
                                <span class="text-gray-700 font-medium">${opt}. ${ex[`option_${opt.toLowerCase()}`]}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function updateAnswer(id, val) {
            quizAnswers[id] = val;
            const el = document.getElementById(`q-container-${id}`);
            if(el) el.style.borderColor = "#e5e7eb"; // Reset màu border
        }

        // 5. Xử lý Nộp bài & Chấm điểm
        function handleSubmitQuiz() {
            const exercises = MOCK_EXERCISES_ID27;
            const answeredCount = Object.keys(quizAnswers).length;
            
            if (answeredCount < exercises.length) {
                alert(`Bạn mới hoàn thành ${answeredCount}/${exercises.length} câu. Hãy làm hết trước khi nộp!`);
                exercises.forEach(ex => {
                    if(!quizAnswers[ex.id]) {
                        const el = document.getElementById(`q-container-${ex.id}`);
                        if(el) el.style.borderColor = "#ef4444"; // Đánh dấu đỏ
                    }
                });
                return;
            }

            if(!confirm("Xác nhận nộp bài?")) return;

            // Chấm điểm
            let score = 0;
            exercises.forEach((ex) => {
                if(quizAnswers[ex.id] === ex.correct_answer) score++;
            });
            const total = exercises.length;
            const scoreText = `${score}/${total}`;

            // Gửi Google Sheets
            const googleScriptUrl = "https://script.google.com/macros/s/AKfycbxaSm0voyg3Cjxe3edtc_wOGDko-ysVqQeUPbiLDAWdpbunE5ugn1rq4JD6NHc3pleW3Q/exec";
            const finalUrl = `${googleScriptUrl}?cotA=${currentContestId}&cotB=${encodeURIComponent(currentUser)}&cotC=${scoreText}`;

            fetch(finalUrl, { mode: 'no-cors' })
                .then(() => console.log("Sent to Google Sheet"))
                .catch(err => console.error(err));

            renderResultPage(exercises, score, total);
        }

        // 6. Hiển thị Kết quả
        function renderResultPage(exercises, score, total) {
            document.getElementById('page-title').innerText = "Kết Quả Bài Thi";
            const percent = (score/total) * 100;
            const isPass = percent >= 70;
            
            let html = `
                <div class="bg-white p-8 rounded-xl shadow-2xl">
                    <div class="text-center mb-8">
                        <div class="inline-block p-6 rounded-full border-4 ${isPass ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'} mb-4">
                            <h2 class="text-4xl font-bold ${isPass ? 'text-green-600' : 'text-red-600'}">${score} / ${total}</h2>
                        </div>
                        <p class="text-xl font-bold text-gray-700">${isPass ? 'XUẤT SẮC! BẠN ĐÃ ĐẠT YÊU CẦU' : 'CẦN CỐ GẮNG HƠN'}</p>
                    </div>

                    <div class="space-y-6">
            `;

            exercises.forEach((ex, index) => {
                const userChoice = quizAnswers[ex.id];
                const isCorrect = userChoice === ex.correct_answer;
                const statusClass = isCorrect ? 'correct-answer' : 'wrong-answer';
                
                html += `
                    <div class="p-4 rounded-lg ${statusClass}">
                        <p class="font-bold text-gray-800 mb-2">Câu ${index + 1}: ${ex.question_text}</p>
                        <div class="ml-4 space-y-1 text-sm text-gray-700">
                             ${['A', 'B', 'C', 'D'].map(opt => {
                                let style = "";
                                const text = ex[`option_${opt.toLowerCase()}`];
                                if (opt === ex.correct_answer) style = "font-weight:bold; color:#16a34a;"; 
                                if (opt === userChoice && !isCorrect) style = "font-weight:bold; color:#dc2626; text-decoration:line-through;";
                                
                                return `<div style="${style}">${opt}. ${text} ${opt === ex.correct_answer ? '(ĐÁP ÁN ĐÚNG)' : ''}</div>`;
                            }).join('')}
                        </div>
                        <div class="mt-2 p-2 bg-white bg-opacity-60 rounded text-sm italic text-gray-600">
                            <i class="fas fa-lightbulb text-yellow-500"></i> ${ex.explanation || "Không có giải thích chi tiết."}
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                    <div class="mt-8 text-center">
                        <button onclick="renderDashboard()" class="btn-action bg-indigo">
                            <i class="fas fa-home"></i> Quay về Trang Chủ
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('dynamic-area').innerHTML = html;
            window.scrollTo(0, 0);
        }

        // Khởi chạy
        window.onload = initSidebar;

    </script>
</body>
</html>
